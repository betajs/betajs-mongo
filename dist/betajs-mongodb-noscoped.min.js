/*!
betajs-mongodb - v1.0.14 - 2019-04-28
Copyright (c) Oliver Friedmann,Pablo Iglesias
Apache-2.0 Software License.
*/

(function(){var t=this.subScope();t.binding("module","global:BetaJS.Data.Databases.Mongo"),t.binding("base","global:BetaJS"),t.binding("data","global:BetaJS.Data"),t.define("module:",function(){return{guid:"1f507e0c-602b-4372-b067-4e19442f28f4",version:"1.0.14",datetime:1556464354280}}),t.assumeVersion("base:version","~1.0.96"),t.assumeVersion("data:version","~1.0.41"),t.define("module:MongoDatabaseTable",["data:Databases.DatabaseTable","base:Promise","base:Objs","base:Types","base:Iterators.ArrayIterator"],function(t,s,i,o,a,e){return t.extend({scoped:e},function(t){return{constructor:function(){t.constructor.apply(this,arguments),this._table_options=this._table_options||[],this._table_options.idkeys=this._table_options.idkeys||[],this._table_options.idkeys.unshift("_id"),this._table_options.datekeys=this._table_options.datekeys||[]},table:function(){return this.__table?s.create(this.__table):this._database.mongodb().mapSuccess(function(t){return this.__table=t.collection(this._table_name),this.__table},this)},primary_key:function(){return"_id"},_encode:function(e,n){if(!e)return e;e=i.map(e,function(t,e){return t&&o.is_object(t)&&!t._bsontype?(this._table_options.datekeys.forEach(function(t){t===e&&(n="date")}),this._encode(t,n)):"date"===n?new Date(t):t},this);var s=this._database.mongo_object_id();return this._table_options.idkeys.forEach(function(t){t in e&&!o.is_object(e[t])&&(e[t]=new s(e[t]+""))},this),this._table_options.datekeys.forEach(function(t){t in e&&!o.is_object(e[t])&&(e[t]=new Date(e[t]))},this),e},_decode:function(e){return e=i.clone(e,1),this._table_options.idkeys.forEach(function(t){t in e&&o.is_object(e[t])&&(e[t]=e[t]+"")},this),this._table_options.datekeys.forEach(function(t){t in e&&o.is_object(e[t])&&(e[t]=e[t].getTime())},this),e},_find:function(e,n){return this.table().mapSuccess(function(t){return s.funcCallback(t,t.find,e).mapSuccess(function(t){return"sort"in(n=n||{})&&(t=t.sort(n.sort)),"skip"in n&&(t=t.skip(n.skip)),"limit"in n&&(t=t.limit(n.limit)),s.funcCallback(t,t.toArray).mapSuccess(function(t){return new a(t)},this)},this)},this)},_count:function(e){return this.table().mapSuccess(function(t){return s.funcCallback(t,t.find,e).mapSuccess(function(t){return s.funcCallback(t,t.count)})})},_insertRow:function(e){return this.table().mapSuccess(function(t){return s.funcCallback(t,t.insertOne,e,this._database._options).mapSuccess(function(t){return e},this)},this)},_insertRows:function(e){return this.table().mapSuccess(function(t){return s.funcCallback(t,t.insertMany,e).mapSuccess(function(t){return row},this)},this)},_removeRow:function(e){return this.table().mapSuccess(function(t){return s.funcCallback(t,t.deleteOne,e)},this)},_removeRows:function(e){return this.table().mapSuccess(function(t){return s.funcCallback(t,t.deleteMany,e)},this)},_updateRow:function(e,n){return this.table().mapSuccess(function(t){return s.funcCallback(t,t.updateOne,e,{$set:n}).mapSuccess(function(){return n})},this)},ensureIndex:function(e){this.table().success(function(t){t.ensureIndex(i.objectBy(e,1))})},_renameTable:function(e){return this.table().mapSuccess(function(t){return s.funcCallback(t,t.rename,e)})}}})}),t.define("module:MongoDatabase",["data:Databases.Database","module:MongoDatabaseTable","base:Strings","base:Types","base:Objs","base:Promise","base:Net.Uri"],function(t,e,s,i,o,a,n,c){return t.extend({scoped:c},function(n){return{constructor:function(t,e){i.is_string(t)?(this.__dbUri=s.strip_start(t,"mongodb://"),this.__dbObject=this.cls.uriToObject(t)):(t=o.extend({database:"database",server:"localhost",port:27017},t),this.__dbObject=t,this.__dbUri=this.cls.objectToUri(t)),this._options=e||{},n.constructor.call(this),this.mongo_module=require("mongodb"),this.__mongo_promise=a.create(),this.__mongo_acquired=!1},_tableClass:function(){return e},mongo_object_id:function(t){return this.mongo_module.ObjectID},generate_object_id:function(t){return new this.mongo_module.ObjectID},mongodb:function(){if(!this.__mongo_acquired){this.__mongo_acquired=!0;var t=a.create();this.mongo_module.MongoClient.connect("mongodb://"+this.__dbUri,{autoReconnect:!0,useNewUrlParser:!0},t.asyncCallbackFunc()),t.success(function(t){this.__mongodb=t.db(this.__dbObject.database),this.__client=t,this.__mongo_promise.asyncSuccess(this.__mongodb)},this)}return this.__mongo_promise},destroy:function(){this.__client&&this.__client.close(),n.destroy.call(this)}}},{uriToObject:function(t){t=t.replace(/,[^\/]+/,"");var e=n.parse(t);return{database:s.strip_start(e.path,"/"),server:e.host,port:e.port,username:e.user,password:e.password}},objectToUri:function(t){return t.path=t.database,n.build(t)}})})}).call(Scoped);