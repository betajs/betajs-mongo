/*!
betajs-mongodb - v1.0.6 - 2018-09-08
Copyright (c) Oliver Friedmann
Apache-2.0 Software License.
*/

(function(){var a=this.subScope();a.binding("module","global:BetaJS.Data.Databases.Mongo"),a.binding("base","global:BetaJS"),a.binding("data","global:BetaJS.Data"),a.define("module:",function(){return{guid:"1f507e0c-602b-4372-b067-4e19442f28f4",version:"1.0.6"}}),a.assumeVersion("base:version","~1.0.96"),a.assumeVersion("data:version","~1.0.41"),a.define("module:MongoDatabaseTable",["data:Databases.DatabaseTable","base:Promise","base:Objs","base:Types","base:Iterators.ArrayIterator"],function(a,b,c,d,e,f){return a.extend({scoped:f},{table:function(){return this.__table?b.create(this.__table):this._database.mongodb().mapSuccess(function(a){return this.__table=a.collection(this._table_name),this.__table},this)},primary_key:function(){return"_id"},_encode:function(a){if(a._id&&!d.is_object(a._id)){a=c.clone(a,1);var b=this._database.mongo_object_id();a._id=new b(a._id+"")}return a},_decode:function(a){return a._id&&d.is_object(a._id)&&(a=c.clone(a,1),a._id=a._id+""),a},_find:function(a,c){return this.table().mapSuccess(function(d){return b.funcCallback(d,d.find,a).mapSuccess(function(a){return c=c||{},"sort"in c&&(a=a.sort(c.sort)),"skip"in c&&(a=a.skip(c.skip)),"limit"in c&&(a=a.limit(c.limit)),b.funcCallback(a,a.toArray).mapSuccess(function(a){return new e(a)},this)},this)},this)},_count:function(a){return this.table().mapSuccess(function(c){return b.funcCallback(c,c.find,a).mapSuccess(function(a){return b.funcCallback(a,a.count)})})},_insertRow:function(a){return this.table().mapSuccess(function(c){return b.funcCallback(c,c.insertOne,a).mapSuccess(function(b){return a},this)},this)},_insertRows:function(a){return this.table().mapSuccess(function(c){return b.funcCallback(c,c.insertMany,a).mapSuccess(function(a){return row},this)},this)},_removeRow:function(a){return this.table().mapSuccess(function(c){return b.funcCallback(c,c.remove,a)},this)},_updateRow:function(a,c){return this.table().mapSuccess(function(d){return b.funcCallback(d,d.updateOne,a,{$set:c}).mapSuccess(function(){return c})},this)},ensureIndex:function(a){({})[a]=1,this.table().success(function(b){b.ensureIndex(c.objectBy(a,1))})},_renameTable:function(a){return this.table().mapSuccess(function(c){return b.funcCallback(c,c.rename,a)})}})}),a.define("module:MongoDatabase",["data:Databases.Database","module:MongoDatabaseTable","base:Strings","base:Types","base:Objs","base:Promise","base:Net.Uri"],function(a,b,c,d,e,f,g,h){return a.extend({scoped:h},function(a){return{constructor:function(b){d.is_string(b)?(this.__dbUri=c.strip_start(b,"mongodb://"),this.__dbObject=this.cls.uriToObject(b)):(b=e.extend({database:"database",server:"localhost",port:27017},b),this.__dbObject=b,this.__dbUri=this.cls.objectToUri(b)),a.constructor.call(this),this.mongo_module=require("mongodb")},_tableClass:function(){return b},mongo_object_id:function(a){return this.mongo_module.ObjectID},mongodb:function(){if(this.__mongodb)return f.value(this.__mongodb);var a=f.create();return this.mongo_module.MongoClient.connect("mongodb://"+this.__dbUri,{autoReconnect:!0},a.asyncCallbackFunc()),a.mapSuccess(function(a){return this.__mongodb=a.db(this.__dbObject.database),this.__client=a,this.__mongodb},this)},destroy:function(){this.__client&&this.__client.close(),a.destroy.call(this)}}},{uriToObject:function(a){a=a.replace(/,[^\/]+/,"");var b=g.parse(a);return{database:c.strip_start(b.path,"/"),server:b.host,port:b.port,username:b.user,password:b.password}},objectToUri:function(a){return a.path=a.database,g.build(a)}})})}).call(Scoped);